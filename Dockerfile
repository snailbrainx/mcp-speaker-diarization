# Use a lightweight Python base image instead of the heavy PyTorch one
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
# ffmpeg: for audio processing
# git: for installing python packages from git
# build-essential: for compiling some python extensions
# portaudio19-dev: for sounddevice
RUN apt-get update && apt-get install -y \
    ffmpeg \
    git \
    build-essential \
    portaudio19-dev \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip
RUN pip install --upgrade pip setuptools wheel

# 1. Install PyTorch with CUDA support FIRST
# This avoids downloading the huge default CPU wheels or reinstalling later
# Using CUDA 12.6 wheels (backward compatible with CUDA 12.4)
# PyTorch 2.8.x is required for pyannote.audio 4.0.x (torchcodec dependency)
# Include torchcodec with GPU support for pyannote.audio's audio I/O
RUN pip install torch==2.8.0 torchvision==0.23.0 torchaudio==2.8.0 torchcodec==0.7.0 --index-url https://download.pytorch.org/whl/cu126

# 2. Install CUDA libraries for faster-whisper / ctranslate2 and torchcodec
# These are needed because we aren't using the nvidia/cuda base image
# - nvidia-npp-cu12: Required by torchcodec for audio decoding
RUN pip install nvidia-cudnn-cu12==9.* nvidia-cublas-cu12 nvidia-npp-cu12

# 3. Install remaining dependencies
# Create constraints file to prevent torch packages from being reinstalled by other deps
COPY requirements.txt .
RUN echo "torch==2.8.0" > /tmp/constraints.txt && \
    echo "torchvision==0.23.0" >> /tmp/constraints.txt && \
    echo "torchaudio==2.8.0" >> /tmp/constraints.txt && \
    echo "torchcodec==0.7.0" >> /tmp/constraints.txt && \
    pip install --no-cache-dir -c /tmp/constraints.txt -r requirements.txt

# Copy application code
COPY app/ /app/app/

# Create directories for data persistence
RUN mkdir -p /app/data /app/volumes /app/backups

# Expose port
EXPOSE 8000

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV DATA_PATH=/app/data
ENV VOLUMES_PATH=/app/volumes

# Set LD_LIBRARY_PATH to include the pip-installed NVIDIA libraries
# This is crucial for ctranslate2/faster-whisper to find cuDNN/cuBLAS
# Also includes nvidia-npp for torchcodec audio decoding
ENV LD_LIBRARY_PATH=/usr/local/lib/python3.11/site-packages/nvidia/cudnn/lib:/usr/local/lib/python3.11/site-packages/nvidia/cublas/lib:/usr/local/lib/python3.11/site-packages/nvidia/npp/lib:$LD_LIBRARY_PATH

# Run the application
CMD ["python", "-m", "app.main"]